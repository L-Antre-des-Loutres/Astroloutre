---
const { PlayerOrUser = '', id = '' } = Astro.props;
export interface Badge {
    id: number;
    joueur_id: number;
    utilisateur_id: number;
    badge_id: number;
    date_recu: string; // ISO 8601 format
    nom: string;
    categorie_id: number;
    actif: number; // 1 = actif, 0 = inactif
    image_url: string;
    description: string;
    obtention: string;
    categorie: string;
    pourcentage_obtention: string; // Stocké en string, peut être converti en number si besoin
}


// Récupération des données
const playerUrl = 'https://otterlyapi.antredesloutres.fr/api/badges/joueurs/'
const userUrl = 'https://otterlyapi.antredesloutres.fr/api/badges/utilisateurs/'

let badges: Badge[] = [];
const switchChoice = PlayerOrUser.toLowerCase();
switch (switchChoice) {
    case 'player':
        const responsePlayer = await fetch(playerUrl + id);
        const json = await responsePlayer.json();
        badges = json.data ?? [];
        break;
    case 'user':
        const responseUser = await fetch(userUrl + id);
        const jsonUser = await responseUser.json();
        badges = jsonUser.data ?? [];
        break;
    default:
        console.error('PlayerOrUser must be "player" or "user" and not "' + PlayerOrUser + '"');
}

let hoveredMethod: string | null = null;
---

<style>
    .badge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        padding: 1rem;
    }

    .badge-card {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        text-align: center;
        padding: 0.75rem;
        transition: transform 0.2s ease;
        font-size: 0.8rem;
        cursor: pointer;
    }

    .badge-card:hover {
        transform: scale(1.05);
    }

    .badge-image {
        width: 64px;
        height: 64px;
        margin: 0 auto 0.5rem;
        border-radius: 0.25rem;
        object-fit: cover;
    }

    .badge-not-obtained .badge-image {
        filter: grayscale(100%);
        opacity: 0.6;
    }

    .badge-name {
        font-weight: 600;
        color: #374151;
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }

    .badge-desc {
        color: #6b7280;
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
    }

    .badge-date {
        font-size: 0.65rem;
        color: #9ca3af;
    }

    .method-box {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 0.75rem;
        text-align: center;
        font-size: 0.8rem;
        animation: slide-up 0.3s ease;
        z-index: 50;
    }

    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
</style>

<div class="badge-grid">
    {badges.map((badge) => (
            <div
                    class={`badge-card ${!badge.date_recu ? "badge-not-obtained" : ""}`}
                    on:mouseenter={() => hoveredMethod = badge.obtention}
                    on:mouseleave={() => hoveredMethod = null}
            >
                <img
                        class="badge-image"
                        src={badge.image_url}
                        alt={badge.nom}
                />
                <div class="badge-name">{badge.nom}</div>
                <div class="badge-desc">{badge.description}</div>
                <div class="badge-date">
                    {badge.date_recu ? `Obtenu le ${badge.date_recu}` : "Non obtenu"}
                </div>
            </div>
    ))}
</div>

{hoveredMethod && (
<div class="method-box">
    {hoveredMethod}
</div>
    )}
